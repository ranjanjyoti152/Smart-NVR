{% extends "base.html" %}

{% block styles %}
<style>
    .face-card {
        margin-bottom: 1.5rem;
        transition: transform 0.2s;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .face-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .face-img-container {
        height: 180px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f8f8;
        border-radius: 8px 8px 0 0;
    }
    
    .face-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .face-name {
        font-weight: 600;
        margin-bottom: 0.3rem;
    }
    
    .face-detail {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .stats-card {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: 700;
    }
    
    .stats-label {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .btn-primary {
        background-color: #007aff;
        border-color: #007aff;
    }
    
    .face-pagination {
        margin-top: 2rem;
    }
    
    /* Modal styles */
    .face-modal-img {
        max-height: 60vh;
    }
    
    .face-modal-body {
        text-align: center;
    }

    /* Dark mode styles */
    [data-theme="dark"] .face-img-container {
        background-color: #2c3035;
    }
    
    [data-theme="dark"] .filter-section {
        background-color: #2c3035;
    }
    
    [data-theme="dark"] .face-detail {
        color: #adb5bd;
    }
    
    /* Loading animation */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem;
    }
    
    .loading-spinner {
        width: 3rem;
        height: 3rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button class="btn btn-sm btn-outline-secondary" id="refresh-faces">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <!-- Filters and Stats -->
        <div class="filter-section">
            <h4>Filter Faces</h4>
            <form id="filter-form">
                <div class="mb-3">
                    <label for="camera-select" class="form-label">Camera</label>
                    <select class="form-select" id="camera-select" name="camera_id">
                        <option value="">All Cameras</option>
                        {% for camera in cameras %}
                        <option value="{{ camera.id }}">{{ camera.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="name-filter" class="form-label">Name</label>
                    <input type="text" class="form-control" id="name-filter" name="name" placeholder="Filter by name">
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="recognized-only" name="recognized_only">
                        <label class="form-check-label" for="recognized-only">
                            Show only recognized faces
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
            </form>

            <hr>

            <h4>Statistics</h4>
            <div class="row">
                <div class="col-md-12">
                    <div class="stats-card bg-primary bg-opacity-10">
                        <div class="stats-number">{{ stats.total }}</div>
                        <div class="stats-label">Total Faces</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card bg-success bg-opacity-10">
                        <div class="stats-number">{{ stats.known }}</div>
                        <div class="stats-label">Known</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stats-card bg-warning bg-opacity-10">
                        <div class="stats-number">{{ stats.unknown }}</div>
                        <div class="stats-label">Unknown</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <!-- Faces Grid -->
        <div class="row" id="faces-container">
            <div class="loading-container">
                <div class="spinner-border loading-spinner text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading faces...</p>
            </div>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Faces pagination" class="face-pagination">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be added dynamically -->
            </ul>
        </nav>
    </div>
</div>

<!-- Face Detail Modal -->
<div class="modal fade" id="face-modal" tabindex="-1" aria-labelledby="face-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="face-modal-label">Face Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body face-modal-body">
                <img src="" class="face-modal-img img-fluid mb-3" id="face-modal-img">
                <div class="mb-3">
                    <input type="text" class="form-control" id="face-name-input" placeholder="Enter name">
                </div>
                <div class="face-details">
                    <p class="mb-2"><strong>Detected:</strong> <span id="face-detected-at"></span></p>
                    <p class="mb-2"><strong>Last seen:</strong> <span id="face-last-seen"></span></p>
                    <p class="mb-2"><strong>Camera:</strong> <span id="face-camera"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="delete-face-btn">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-face-name-btn">Save Name</button>
            </div>
        </div>
    </div>
</div>

<!-- Face Card Template -->
<template id="face-card-template">
    <div class="col-md-4 col-lg-3">
        <div class="face-card card">
            <div class="face-img-container">
                <img src="" class="face-img" alt="Detected Face">
            </div>
            <div class="card-body">
                <h6 class="face-name"></h6>
                <p class="face-detail">
                    <small>Detected: <span class="detected-at"></span></small><br>
                    <small>Camera: <span class="camera-name"></span></small>
                </p>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentPage = 1;
let totalPages = 1;
let currentFaceId = null;
let faceModal = null;

// Initialize on document ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap modal
    faceModal = new bootstrap.Modal(document.getElementById('face-modal'));
    
    // Load faces with default parameters
    loadFaces();
    
    // Set up event listeners
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 1; // Reset to first page when applying filters
        loadFaces();
    });
    
    document.getElementById('refresh-faces').addEventListener('click', function() {
        loadFaces();
    });
    
    document.getElementById('save-face-name-btn').addEventListener('click', function() {
        saveFaceName();
    });
    
    document.getElementById('delete-face-btn').addEventListener('click', function() {
        deleteFace();
    });
});

// Function to load faces from API
function loadFaces() {
    const facesContainer = document.getElementById('faces-container');
    facesContainer.innerHTML = `
        <div class="loading-container">
            <div class="spinner-border loading-spinner text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading faces...</p>
        </div>
    `;
    
    // Get filter values
    const cameraId = document.getElementById('camera-select').value;
    const name = document.getElementById('name-filter').value;
    const recognizedOnly = document.getElementById('recognized-only').checked;
    
    // Build query string
    let queryParams = new URLSearchParams();
    if (cameraId) queryParams.append('camera_id', cameraId);
    if (name) queryParams.append('name', name);
    if (recognizedOnly) queryParams.append('recognized_only', 'true');
    queryParams.append('page', currentPage);
    queryParams.append('per_page', 20);
    
    // Make API request
    fetch(`/api/faces?${queryParams.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFaces(data.faces);
                updatePagination(data.pagination);
            } else {
                facesContainer.innerHTML = `<div class="col-12 text-center">
                    <p class="text-danger">Error loading faces: ${data.message || 'Unknown error'}</p>
                </div>`;
            }
        })
        .catch(error => {
            facesContainer.innerHTML = `<div class="col-12 text-center">
                <p class="text-danger">Error: ${error.message}</p>
            </div>`;
            console.error('Error loading faces:', error);
        });
}

// Display faces in the grid
function displayFaces(faces) {
    const facesContainer = document.getElementById('faces-container');
    facesContainer.innerHTML = '';
    
    if (faces.length === 0) {
        facesContainer.innerHTML = `<div class="col-12 text-center">
            <p>No faces found matching your criteria.</p>
        </div>`;
        return;
    }
    
    const template = document.getElementById('face-card-template');
    
    faces.forEach(face => {
        // Clone the template
        const faceCard = template.content.cloneNode(true);
        
        // Set face data
        const imgElement = faceCard.querySelector('.face-img');
        imgElement.src = `/api/faces/${face.id}/image`;
        imgElement.alt = face.name || 'Unknown Person';
        
        faceCard.querySelector('.face-name').textContent = face.name || 'Unknown Person';
        
        // Format the date
        const detectedDate = new Date(face.detected_at);
        faceCard.querySelector('.detected-at').textContent = formatDate(detectedDate);
        
        // Set the camera name
        faceCard.querySelector('.camera-name').textContent = face.camera_name || 'Unknown';
        
        // Add click event to open modal
        const card = faceCard.querySelector('.face-card');
        card.addEventListener('click', () => openFaceModal(face));
        
        // Add card to container
        facesContainer.appendChild(faceCard);
    });
}

// Update pagination controls
function updatePagination(pagination) {
    const paginationElement = document.getElementById('pagination');
    paginationElement.innerHTML = '';
    
    totalPages = pagination.pages;
    currentPage = pagination.page;
    
    if (totalPages <= 1) {
        return; // Don't show pagination for a single page
    }
    
    // Previous button
    const prevItem = document.createElement('li');
    prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    const prevLink = document.createElement('a');
    prevLink.className = 'page-link';
    prevLink.href = '#';
    prevLink.innerHTML = '&laquo;';
    prevLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) {
            currentPage--;
            loadFaces();
        }
    });
    prevItem.appendChild(prevLink);
    paginationElement.appendChild(prevItem);
    
    // Page numbers
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    
    if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
        const pageLink = document.createElement('a');
        pageLink.className = 'page-link';
        pageLink.href = '#';
        pageLink.textContent = i;
        pageLink.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            loadFaces();
        });
        pageItem.appendChild(pageLink);
        paginationElement.appendChild(pageItem);
    }
    
    // Next button
    const nextItem = document.createElement('li');
    nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    const nextLink = document.createElement('a');
    nextLink.className = 'page-link';
    nextLink.href = '#';
    nextLink.innerHTML = '&raquo;';
    nextLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < totalPages) {
            currentPage++;
            loadFaces();
        }
    });
    nextItem.appendChild(nextLink);
    paginationElement.appendChild(nextItem);
}

// Format date for display
function formatDate(date) {
    if (!(date instanceof Date) || isNaN(date)) {
        return 'Unknown';
    }
    
    // Check if it's today
    const today = new Date();
    if (date.toDateString() === today.toDateString()) {
        return `Today at ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    }
    
    // Check if it's yesterday
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === yesterday.toDateString()) {
        return `Yesterday at ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
    }
    
    // Otherwise, show full date
    return date.toLocaleString();
}

// Open face modal with details
function openFaceModal(face) {
    currentFaceId = face.id;
    
    // Set modal content
    document.getElementById('face-modal-img').src = `/api/faces/${face.id}/image`;
    document.getElementById('face-name-input').value = face.name || '';
    document.getElementById('face-detected-at').textContent = formatDate(new Date(face.detected_at));
    
    if (face.last_seen_at) {
        document.getElementById('face-last-seen').textContent = formatDate(new Date(face.last_seen_at));
    } else {
        document.getElementById('face-last-seen').textContent = formatDate(new Date(face.detected_at));
    }
    
    document.getElementById('face-camera').textContent = face.camera_name || 'Unknown';
    
    // Show the modal
    faceModal.show();
}

// Save face name
function saveFaceName() {
    if (!currentFaceId) return;
    
    const nameInput = document.getElementById('face-name-input');
    const name = nameInput.value.trim();
    
    if (!name) {
        alert('Please enter a name for this face');
        return;
    }
    
    // Make API request to update name
    fetch(`/api/faces/${currentFaceId}/name`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: name }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload faces
            faceModal.hide();
            loadFaces();
            
            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    Face name updated to "${name}" successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.querySelector('.container-fluid').insertAdjacentHTML('afterbegin', alertHtml);
        } else {
            alert(`Error updating name: ${data.message || 'Unknown error'}`);
        }
    })
    .catch(error => {
        alert(`Error: ${error.message}`);
        console.error('Error updating face name:', error);
    });
}

// Delete face
function deleteFace() {
    if (!currentFaceId) return;
    
    if (!confirm('Are you sure you want to delete this face record?')) {
        return;
    }
    
    // Make API request to delete face
    fetch(`/api/faces/${currentFaceId}`, {
        method: 'DELETE',
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload faces
            faceModal.hide();
            loadFaces();
            
            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    Face deleted successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.querySelector('.container-fluid').insertAdjacentHTML('afterbegin', alertHtml);
        } else {
            alert(`Error deleting face: ${data.message || 'Unknown error'}`);
        }
    })
    .catch(error => {
        alert(`Error: ${error.message}`);
        console.error('Error deleting face:', error);
    });
}
</script>
{% endblock %}