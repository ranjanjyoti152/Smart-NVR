{% extends "base.html" %}

{% block content %}
<div class="mac-content-header">
    <div>
        <h2>Camera Management</h2>
        <p class="text-muted">Add and configure your IP cameras</p>
    </div>
    <div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCameraModal">
            <i class="fas fa-plus"></i> Add Camera
        </button>
    </div>
</div>

<div class="row">
    {% if cameras %}
        {% for camera in cameras %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="mac-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-video me-2"></i>{{ camera.name }}</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input camera-toggle" type="checkbox" role="switch" 
                            id="camera-enabled-{{ camera.id }}" data-camera-id="{{ camera.id }}" 
                            {% if camera.enabled %}checked{% endif %}>
                        <label class="form-check-label" for="camera-enabled-{{ camera.id }}">
                            {{ 'Enabled' if camera.enabled else 'Disabled' }}
                        </label>
                    </div>
                </div>
                <p class="camera-url"><strong>URL:</strong> {{ camera.url }}</p>
                <p class="camera-location"><strong>Location:</strong> {{ camera.location }}</p>
                <div class="d-flex gap-2 mb-3">
                    <span class="badge {% if camera.status == 'online' %}badge-status-online{% else %}badge-status-offline{% endif %}\">
                        {{ camera.status|capitalize }}
                    </span>
                    <span class="badge {% if camera.recording_enabled %}badge-recording-enabled{% else %}badge-recording-disabled{% endif %}\">
                        {{ 'Recording' if camera.recording_enabled else 'Not Recording' }}
                    </span>
                    <span class="badge {% if camera.detection_enabled %}badge-detection-enabled{% else %}badge-detection-disabled{% endif %}\">
                        {{ 'AI Detection' if camera.detection_enabled else 'No AI Detection' }}
                    </span>
                </div>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary edit-camera"
                        data-camera-id="{{ camera.id }}" data-bs-toggle="modal" data-bs-target="#editCameraModal">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button type="button" class="btn btn-outline-info manage-roi"
                        data-camera-id="{{ camera.id }}" data-camera-name="{{ camera.name }}"
                        data-bs-toggle="modal" data-bs-target="#roiModal">
                        <i class="fas fa-draw-polygon"></i> Manage ROI
                    </button>
                    <button type="button" class="btn btn-outline-danger delete-camera"
                        data-camera-id="{{ camera.id }}" data-camera-name="{{ camera.name }}"
                        data-bs-toggle="modal" data-bs-target="#deleteCameraModal">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="mac-card d-flex p-4">
                <div class="text-center w-100">
                    <i class="fas fa-camera-slash fa-3x mb-3" style="color: var(--color-muted);"></i>
                    <p class="text-muted mb-3">No cameras have been added yet.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                        <i class="fas fa-plus"></i> Add Your First Camera
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Add Camera Modal -->
<div class="modal fade" id="addCameraModal" tabindex="-1" aria-labelledby="addCameraModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--mac-sidebar-bg);">
                <h5 class="modal-title" id="addCameraModalLabel">Add New Camera</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.add_camera') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Camera Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="rtsp_url" class="form-label">RTSP URL</label>
                        <input type="text" class="form-control" id="rtsp_url" name="rtsp_url" 
                            placeholder="rtsp://example.com/stream" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location">
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username (if required)</label>
                        <input type="text" class="form-control" id="username" name="username">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password (if required)</label>
                        <input type="password" class="form-control" id="password" name="password">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="enabled" name="enabled" checked>
                                <label class="form-check-label" for="enabled">
                                    Enable Camera
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="recording_enabled" name="recording_enabled" checked>
                                <label class="form-check-label" for="recording_enabled">
                                    Enable Recording
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="detection_enabled" name="detection_enabled" checked>
                        <label class="form-check-label" for="detection_enabled">
                            Enable AI Detection
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Camera</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Camera Modal (will be populated by JavaScript) -->
<div class="modal fade" id="editCameraModal" tabindex="-1" aria-labelledby="editCameraModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--mac-sidebar-bg);">
                <h5 class="modal-title" id="editCameraModalLabel">Edit Camera</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCameraForm" action="{{ url_for('main.edit_camera', camera_id=0) }}" method="post">
                <div class="modal-body">
                    <!-- To be populated dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Camera Confirmation Modal -->
<div class="modal fade" id="deleteCameraModal" tabindex="-1" aria-labelledby="deleteCameraModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--mac-sidebar-bg);">
                <h5 class="modal-title" id="deleteCameraModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <p>Are you sure you want to delete the camera "<span id="deleteCameraName"></span>"?</p>
                    <p class="mb-0">This will permanently remove the camera and all its recordings.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteCameraForm" action="{{ url_for('main.delete_camera', camera_id=0) }}" method="post">
                    <button type="submit" class="btn btn-danger">Delete Camera</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ROI Management Modal -->
<div class="modal fade" id="roiModal" tabindex="-1" aria-labelledby="roiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--mac-sidebar-bg);">
                <h5 class="modal-title" id="roiModalLabel">Manage Regions of Interest</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mac-card p-0 mb-3" style="overflow: hidden;">
                            <div class="camera-feed-container" style="position: relative; overflow: hidden;">
                                <img id="cameraFeed" src="" alt="Camera Feed" style="width: 100%; max-width: 100%;">
                                <canvas id="roiCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" id="btnStartDrawing">
                                <i class="fas fa-pen"></i> Start Drawing
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="btnClearDrawing">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mac-card">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-map-marker-alt me-2" style="color: var(--color-primary);"></i>
                                <h5 class="mb-0">Regions of Interest</h5>
                            </div>
                            <div id="roiList" class="list-group mb-3">
                                <!-- ROI items will be loaded here -->
                                <div class="text-center py-3" id="noRoiMessage">
                                    <p class="text-muted">No regions defined yet</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="roiName" class="form-label">Region Name</label>
                                <input type="text" class="form-control" id="roiName" placeholder="e.g., Front Door">
                            </div>
                            <div class="mb-3">
                                <label for="detectionClasses" class="form-label">Object Classes to Detect</label>
                                <select class="form-select" id="detectionClasses" multiple>
                                    <!-- Classes will be dynamically loaded -->
                                </select>
                                <div class="form-text">Hold Ctrl/Cmd to select multiple or leave empty for all classes</div>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" name="emailNotifications">
                                <label class="form-check-label" for="emailNotifications">
                                    Enable Email Notifications for this Region
                                </label>
                                <div class="form-text">When checked, an email will be sent when objects are detected in this region</div>
                            </div>

                            <!-- Redesigned Smart Email Notifications section -->
                            <div class="mac-card mb-3 p-0 border-info">
                                <div class="d-flex align-items-center p-2" style="background: rgba(var(--bs-info-rgb), 0.1);">
                                    <i class="fas fa-envelope-open-text text-info me-2"></i>
                                    <span class="fw-bold">Smart Email Notifications</span>
                                    <button type="button" class="btn btn-sm ms-auto p-0 border-0" 
                                        data-bs-toggle="collapse" data-bs-target="#smartEmailHelp" 
                                        aria-expanded="false" aria-controls="smartEmailHelp">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </div>
                                <div class="collapse show p-3" id="smartEmailHelp">
                                    <!-- Disclaimer alert -->
                                    <div class="alert alert-warning small py-2 mb-3">
                                        <strong>Disclaimer:</strong> To enable Smart Notifications, the detection model must be properly trained. The default model may not support all use cases. Please train and use a custom model tailored to your specific requirements.
                                    </div>
                                    
                                    <p class="text-muted small mb-2">Add these keywords to your region name for specialized alerts:</p>
                                    
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <!-- Notification types -->
                                        <div class="notification-type security p-2 rounded" style="background: rgba(var(--bs-danger-rgb), 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-shield-alt text-danger me-1"></i>
                                                <span class="fw-bold small">Intrusion</span>
                                            </div>
                                            <span class="badge bg-danger bg-opacity-10 text-danger small">Security breach alerts</span>
                                        </div>
                                        
                                        <div class="notification-type fire p-2 rounded" style="background: rgba(var(--bs-danger-rgb), 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-fire text-danger me-1"></i>
                                                <span class="fw-bold small">Fire</span>
                                            </div>
                                            <span class="badge bg-danger bg-opacity-10 text-danger small">Evacuation instructions</span>
                                        </div>
                                        
                                        <div class="notification-type smoke p-2 rounded" style="background: rgba(var(--bs-warning-rgb), 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-smoking text-warning me-1"></i>
                                                <span class="fw-bold small">Smoke</span>
                                            </div>
                                            <span class="badge bg-warning bg-opacity-10 text-warning small">Early warnings</span>
                                        </div>
                                        
                                        <div class="notification-type safety p-2 rounded" style="background: rgba(var(--bs-primary-rgb), 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-hard-hat text-primary me-1"></i>
                                                <span class="fw-bold small">Helmet/Safety</span>
                                            </div>
                                            <span class="badge bg-primary bg-opacity-10 text-primary small">Compliance info</span>
                                        </div>

                                        <div class="notification-type loitering p-2 rounded" style="background: rgba(var(--bs-secondary-rgb), 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-clock text-secondary me-1"></i>
                                                <span class="fw-bold small">Loitering</span>
                                            </div>
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary small">Suspicious activity</span>
                                        </div>

                                        <div class="notification-type vehicle p-2 rounded" style="background: rgba(var(--bs-info-rgb), 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-car text-info me-1"></i>
                                                <span class="fw-bold small">Vehicle</span>
                                            </div>
                                            <span class="badge bg-info bg-opacity-10 text-info small">Vehicle presence</span>
                                        </div>

                                        <div class="notification-type package p-2 rounded" style="background: rgba(121, 85, 72, 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-box-open me-1" style="color: #795548;"></i>
                                                <span class="fw-bold small">Package</span>
                                            </div>
                                            <span class="badge" style="background-color: rgba(121, 85, 72, 0.1); color: #795548;">Delivery alerts</span>
                                        </div>

                                        <div class="notification-type animal p-2 rounded" style="background: rgba(var(--bs-success-rgb), 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-paw text-success me-1"></i>
                                                <span class="fw-bold small">Animal</span>
                                            </div>
                                            <span class="badge bg-success bg-opacity-10 text-success small">Wildlife/pet detection</span>
                                        </div>

                                        <div class="notification-type fall p-2 rounded" style="background: rgba(156, 39, 176, 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-user-injured me-1" style="color: #9C27B0;"></i>
                                                <span class="fw-bold small">Fall</span>
                                            </div>
                                            <span class="badge" style="background-color: rgba(156, 39, 176, 0.1); color: #9C27B0;">Potential fall incident</span>
                                        </div>

                                        <div class="notification-type parking p-2 rounded" style="background: rgba(63, 81, 181, 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-parking me-1" style="color: #3F51B5;"></i>
                                                <span class="fw-bold small">Parking</span>
                                            </div>
                                            <span class="badge" style="background-color: rgba(63, 81, 181, 0.1); color: #3F51B5;">Parking violation detection</span>
                                        </div>

                                        <div class="notification-type restricted p-2 rounded" style="background: rgba(233, 30, 99, 0.05);">
                                            <div class="d-flex align-items-center mb-1">
                                                <i class="fas fa-ban me-1" style="color: #E91E63;"></i>
                                                <span class="fw-bold small">Restricted</span>
                                            </div>
                                            <span class="badge" style="background-color: rgba(233, 30, 99, 0.1); color: #E91E63;">Unauthorized vehicle alerts</span>
                                        </div>
                                    </div>
                                    
                                    <p class="small text-muted mb-0 fst-italic">Example: "Front Door <mark>Intrusion</mark> Zone", "Driveway <mark>Vehicle</mark> Area", "Car <mark>Parking</mark> Only", "<mark>Restricted</mark> No Trucks Zone"</p>
                                </div>
                            </div>
                            
                            <button id="btnSaveROI" class="btn btn-primary w-100" disabled>
                                <i class="fas fa-save me-1"></i> Save Region
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Script to handle camera edit modal
document.querySelectorAll('.edit-camera').forEach(button => {
    button.addEventListener('click', function() {
        const cameraId = this.getAttribute('data-camera-id');
        
        // Set the exact full path instead of trying to replace parts of it
        const form = document.getElementById('editCameraForm');
        form.action = `/edit-camera/${cameraId}`;
        
        // Log for debugging
        console.log(`Set edit form action to: ${form.action} for camera ID: ${cameraId}`);
    });
});

// Script to handle camera delete modal
document.querySelectorAll('.delete-camera').forEach(button => {
    button.addEventListener('click', function() {
        const cameraId = this.getAttribute('data-camera-id');
        const cameraName = this.getAttribute('data-camera-name');
        document.getElementById('deleteCameraName').textContent = cameraName;
        const form = document.getElementById('deleteCameraForm');
        
        // Set the exact full path instead of trying to replace parts of it
        form.action = `/delete-camera/${cameraId}`;
        
        // Log for debugging
        console.log(`Set delete form action to: ${form.action} for camera ${cameraName} (ID: ${cameraId})`);
    });
});

// ROI Management Scripts
document.querySelectorAll('.manage-roi').forEach(button => {
    button.addEventListener('click', function() {
        const cameraId = this.getAttribute('data-camera-id');
        const cameraName = this.getAttribute('data-camera-name');
        document.getElementById('roiModalLabel').textContent = `Manage ROIs - ${cameraName}`;
        
        // Load camera feed
        const cameraFeed = document.getElementById('cameraFeed');
        cameraFeed.src = `/api/cameras/${cameraId}/frame?t=${Date.now()}`;
        
        // Set up canvas
        setupROICanvas(cameraId);
        
        // Load existing ROIs
        loadROIs(cameraId);
        
        // Store camera ID for later use
        document.getElementById('roiCanvas').dataset.cameraId = cameraId;
    });
});

// Set up canvas for drawing ROIs
function setupROICanvas(cameraId) {
    const canvas = document.getElementById('roiCanvas');
    const ctx = canvas.getContext('2d');
    const cameraFeed = document.getElementById('cameraFeed');
    
    // Wait for image to load to set canvas dimensions
    cameraFeed.onload = function() {
        canvas.width = cameraFeed.width;
        canvas.height = cameraFeed.height;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    };
    
    // Drawing state
    let isDrawing = false;
    let points = [];
    
    // Set up drawing events
    const btnStartDrawing = document.getElementById('btnStartDrawing');
    const btnClearDrawing = document.getElementById('btnClearDrawing');
    const btnSaveROI = document.getElementById('btnSaveROI');
    
    // Remove existing event listeners to prevent duplicates
    const newBtnStartDrawing = btnStartDrawing.cloneNode(true);
    btnStartDrawing.parentNode.replaceChild(newBtnStartDrawing, btnStartDrawing);
    
    const newBtnClearDrawing = btnClearDrawing.cloneNode(true);
    btnClearDrawing.parentNode.replaceChild(newBtnClearDrawing, btnClearDrawing);
    
    const newBtnSaveROI = btnSaveROI.cloneNode(true);
    btnSaveROI.parentNode.replaceChild(newBtnSaveROI, btnSaveROI);
    
    // Re-get references to the new buttons
    const startDrawingBtn = document.getElementById('btnStartDrawing');
    const clearDrawingBtn = document.getElementById('btnClearDrawing');
    const saveROIBtn = document.getElementById('btnSaveROI');
    
    // Load object classes from the model
    const detectionClassesSelect = document.getElementById('detectionClasses');
    
    // Clear existing options
    detectionClassesSelect.innerHTML = '';
    
    // Show loading message in the select box
    const loadingOption = document.createElement('option');
    loadingOption.textContent = 'Loading classes...';
    loadingOption.disabled = true;
    loadingOption.selected = true;
    detectionClassesSelect.appendChild(loadingOption);
    
    // Fetch the classes from the API
    fetch(`/api/model_classes`)
        .then(response => response.json())
        .then(data => {
            // Remove loading message
            detectionClassesSelect.innerHTML = '';
            
            if (data.success && data.classes && data.classes.length > 0) {
                // Add classes to the select element
                data.classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    detectionClassesSelect.appendChild(option);
                });
                
                console.log(`Loaded ${data.classes.length} classes from model`);
            } else {
                // Add a placeholder if no classes were found
                const option = document.createElement('option');
                option.textContent = 'No classes found';
                option.disabled = true;
                detectionClassesSelect.appendChild(option);
                console.error('No classes found');
            }
        })
        .catch(error => {
            console.error('Error loading model classes:', error);
            detectionClassesSelect.innerHTML = '';
            const option = document.createElement('option');
            option.textContent = 'Error loading classes';
            option.disabled = true;
            detectionClassesSelect.appendChild(option);
        });
    
    // Add event listeners to the new buttons
    startDrawingBtn.addEventListener('click', function() {
        isDrawing = true;
        points = [];
        this.classList.remove('btn-outline-primary');
        this.classList.add('btn-primary');
        saveROIBtn.disabled = true;
    });
    
    clearDrawingBtn.addEventListener('click', function() {
        isDrawing = false;
        points = [];
        startDrawingBtn.classList.remove('btn-primary');
        startDrawingBtn.classList.add('btn-outline-primary');
        saveROIBtn.disabled = true;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
    
    // Remove existing canvas click handler by cloning and replacing
    const newCanvas = canvas.cloneNode(true);
    canvas.parentNode.replaceChild(newCanvas, canvas);
    
    // Get reference to the new canvas
    const drawCanvas = document.getElementById('roiCanvas');
    drawCanvas.dataset.cameraId = cameraId;
    
    // Add click handler to the new canvas
    drawCanvas.addEventListener('click', function(e) {
        if (!isDrawing) return;
        
        const rect = drawCanvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / (rect.right - rect.left) * drawCanvas.width;
        const y = (e.clientY - rect.top) / (rect.bottom - rect.top) * drawCanvas.height;
        
        // Add point
        points.push([x, y]);
        
        // Draw point
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, 2 * Math.PI);
        ctx.fill();
        
        // Draw line if we have more than one point
        if (points.length > 1) {
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(points[points.length - 2][0], points[points.length - 2][1]);
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        // If we have at least 3 points, draw a line back to the first point
        if (points.length >= 3) {
            ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(points[0][0], points[0][1]);
            ctx.stroke();
            
            // Fill the polygon with semi-transparent color
            ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
            ctx.beginPath();
            ctx.moveTo(points[0][0], points[0][1]);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i][0], points[i][1]);
            }
            ctx.closePath();
            ctx.fill();
            
            // Enable the save button
            saveROIBtn.disabled = false;
        }
    });
    
    // Add new save ROI event handler
    saveROIBtn.addEventListener('click', function() {
        console.log("Save ROI button clicked");
        const roiName = document.getElementById('roiName').value || `ROI ${Date.now()}`;
        
        // Get selected detection classes
        const detectionClassesSelect = document.getElementById('detectionClasses');
        const selectedClasses = Array.from(detectionClassesSelect.selectedOptions).map(option => parseInt(option.value));
        
        // Get email notification setting
        const emailNotifications = document.getElementById('emailNotifications').checked;
        
        // Normalize points to percentages for responsive display
        const normalizedPoints = points.map(point => [
            point[0] / drawCanvas.width,
            point[1] / drawCanvas.height
        ]);
        
        // Verify we have enough points for a valid polygon
        if (normalizedPoints.length < 3) {
            alert('Please draw a complete polygon with at least 3 points.');
            return;
        }
        
        // Prepare data for API
        const roiData = {
            name: roiName,
            coordinates: normalizedPoints,
            detection_classes: selectedClasses,
            is_active: true,
            email_notifications: emailNotifications
        };
        
        console.log("ROI Data to save:", roiData);
        
        // Disable the save button to prevent double submission
        saveROIBtn.disabled = true;
        saveROIBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        
        // Save ROI via API
        fetch(`/api/cameras/${cameraId}/roi`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(roiData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log("ROI saved successfully:", data);
                // Reset drawing
                isDrawing = false;
                points = [];
                startDrawingBtn.classList.remove('btn-primary');
                startDrawingBtn.classList.add('btn-outline-primary');
                ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
                document.getElementById('roiName').value = '';
                detectionClassesSelect.selectedIndex = -1;
                document.getElementById('emailNotifications').checked = false;
                
                // Show success message
                alert('Region of Interest saved successfully!');
                
                // Wait a brief moment for the backend to process before reloading ROIs
                setTimeout(() => {
                    // Reload ROIs with a forced cache-busting parameter
                    loadROIs(cameraId, true);
                }, 500);
            } else {
                console.error('Error saving ROI:', data);
                alert('Error saving ROI: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving ROI:', error);
            alert('Error saving ROI: ' + error.message);
        })
        .finally(() => {
            // Always reset the button state regardless of success or error
            saveROIBtn.disabled = false;
            saveROIBtn.innerHTML = 'Save Region';
        });
    });
}

// Load existing ROIs for a camera
function loadROIs(cameraId) {
    const roiList = document.getElementById('roiList');
    const noRoiMessage = document.getElementById('noRoiMessage');
    const canvas = document.getElementById('roiCanvas');
    const ctx = canvas.getContext('2d');
    
    console.log(`Loading ROIs for camera ${cameraId}...`);
    
    // Clear list and canvas
    roiList.innerHTML = '';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Show loading message
    const loadingItem = document.createElement('div');
    loadingItem.className = 'text-center py-3';
    loadingItem.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Loading ROIs...';
    roiList.appendChild(loadingItem);
    
    // Fetch ROIs from the API
    fetch(`/api/cameras/${cameraId}/roi`)
        .then(response => response.json())
        .then(data => {
            // Remove loading message
            roiList.removeChild(loadingItem);
            
            // Reset the no ROI message container
            noRoiMessage.style.display = 'none';
            
            if (data.success && data.roi && data.roi.length > 0) {
                // Add each ROI to the list
                data.roi.forEach((roi, index) => {
                    const roiItem = document.createElement('a');
                    roiItem.href = '#';
                    roiItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    
                    // Add email notification badge if enabled
                    let emailBadge = '';
                    if (roi.email_notifications) {
                        emailBadge = '<span class="badge bg-success ms-2"><i class="fas fa-envelope"></i></span>';
                    }
                    
                    // Create the ROI item content
                    roiItem.innerHTML = `
                        <div>${roi.name} ${emailBadge}</div>
                        <button class="btn btn-sm btn-danger delete-roi" data-roi-id="${roi.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    roiList.appendChild(roiItem);
                    
                    // Add click handler to highlight ROI when clicked
                    roiItem.addEventListener('click', function(e) {
                        // Ignore if clicked on delete button
                        if (e.target.closest('.delete-roi')) return;
                        
                        // Remove active class from all ROIs
                        document.querySelectorAll('#roiList a').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // Add active class to this ROI
                        roiItem.classList.add('active');
                        
                        // Show this ROI on the canvas
                        displayROI(roi, ctx, canvas);
                    });
                    
                    // Setup delete button handler
                    const deleteBtn = roiItem.querySelector('.delete-roi');
                    deleteBtn.addEventListener('click', function() {
                        deleteROI(cameraId, roi.id);
                    });
                    
                    // If this is the first ROI, highlight it
                    if (index === 0) {
                        roiItem.classList.add('active');
                    }
                });
                
                // Display all ROIs at once
                displayAllROIs(data.roi, ctx, canvas);
                
                console.log(`Loaded ${data.roi.length} ROIs for camera ${cameraId}`);
            } else {
                // No ROIs found, show the message
                noRoiMessage.style.display = 'block';
                console.log(`No ROIs found for camera ${cameraId}`);
            }
        })
        .catch(error => {
            console.error('Error loading ROIs:', error);
            
            // Remove loading message and show error
            roiList.removeChild(loadingItem);
            
            const errorItem = document.createElement('div');
            errorItem.className = 'alert alert-danger py-2';
            errorItem.textContent = 'Error loading ROIs';
            roiList.appendChild(errorItem);
        });
}

// Display a single ROI on the canvas
function displayROI(roi, ctx, canvas) {
    // Clear the canvas first
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!roi || !roi.coordinates || roi.coordinates.length < 3) {
        console.error("Invalid ROI or coordinates:", roi);
        return;
    }
    
    // Get normalized coordinates
    const coordinates = roi.coordinates;
    
    // Draw the ROI polygon
    ctx.beginPath();
    
    // Start from the first point
    const firstPoint = getCoordinatePoint(coordinates[0], canvas);
    ctx.moveTo(firstPoint[0], firstPoint[1]);
    
    // Draw lines to the other points
    for (let i = 1; i < coordinates.length; i++) {
        const point = getCoordinatePoint(coordinates[i], canvas);
        ctx.lineTo(point[0], point[1]);
    }
    
    // Close the path
    ctx.closePath();
    
    // Fill with semi-transparent blue
    ctx.fillStyle = 'rgba(0, 0, 255, 0.2)';
    ctx.fill();
    
    // Stroke with blue
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Add the ROI name near the center
    const points = coordinates.map(coord => getCoordinatePoint(coord, canvas));
    const centerX = points.reduce((sum, point) => sum + point[0], 0) / points.length;
    const centerY = points.reduce((sum, point) => sum + point[1], 0) / points.length;
    
    // Add text with border for visibility
    ctx.font = '16px Arial';
    ctx.fillStyle = 'white';
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 3;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.strokeText(roi.name, centerX, centerY);
    ctx.fillText(roi.name, centerX, centerY);
    
    // Add email notification indicator if enabled
    if (roi.email_notifications) {
        ctx.font = '14px Arial';
        ctx.fillStyle = '#66FF66';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.strokeText('📧', centerX, centerY + 20);
        ctx.fillText('📧', centerX, centerY + 20);
    }
}

// Display all ROIs on the canvas with different colors
function displayAllROIs(rois, ctx, canvas) {
    if (!rois || !rois.length || !ctx || !canvas) return;
    
    // Define colors for different ROIs
    const colors = ['blue', 'green', 'purple', 'orange', 'cyan', 'magenta', 'brown', 'pink'];
    
    // Clear the canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw each ROI
    rois.forEach((roi, index) => {
        if (!roi.coordinates || roi.coordinates.length < 3) {
            console.error("Invalid ROI coordinates for:", roi);
            return;
        }
        
        // Get color for this ROI (cycle through colors if more ROIs than colors)
        const color = colors[index % colors.length];
        const fillColor = color === 'blue' ? 'rgba(0, 0, 255, 0.2)' : 
                         color === 'green' ? 'rgba(0, 128, 0, 0.2)' :
                         color === 'purple' ? 'rgba(128, 0, 128, 0.2)' :
                         color === 'orange' ? 'rgba(255, 165, 0, 0.2)' :
                         color === 'cyan' ? 'rgba(0, 255, 255, 0.2)' :
                         color === 'magenta' ? 'rgba(255, 0, 255, 0.2)' :
                         color === 'brown' ? 'rgba(165, 42, 42, 0.2)' :
                         'rgba(255, 192, 203, 0.2)';
        
        // Get coordinates
        const coordinates = roi.coordinates;
        
        // Draw the polygon
        ctx.beginPath();
        
        // Start from the first point
        const firstPoint = getCoordinatePoint(coordinates[0], canvas);
        ctx.moveTo(firstPoint[0], firstPoint[1]);
        
        // Draw lines to the other points
        for (let i = 1; i < coordinates.length; i++) {
            const point = getCoordinatePoint(coordinates[i], canvas);
            ctx.lineTo(point[0], point[1]);
        }
        
        // Close the path
        ctx.closePath();
        
        // Fill with semi-transparent color
        ctx.fillStyle = fillColor;
        ctx.fill();
        
        // Stroke with solid color
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // Add the ROI name near the center
        const points = coordinates.map(coord => getCoordinatePoint(coord, canvas));
        const centerX = points.reduce((sum, point) => sum + point[0], 0) / points.length;
        const centerY = points.reduce((sum, point) => sum + point[1], 0) / points.length;
        
        // Add text with border for visibility
        ctx.font = '16px Arial';
        ctx.fillStyle = 'white';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.strokeText(roi.name, centerX, centerY);
        ctx.fillText(roi.name, centerX, centerY);
        
        // Add email notification indicator if enabled
        if (roi.email_notifications) {
            ctx.font = '14px Arial';
            ctx.fillStyle = '#66FF66';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.strokeText('📧', centerX, centerY + 20);
            ctx.fillText('📧', centerX, centerY + 20);
        }
    });
}

// Helper function to get canvas pixel coordinates from normalized or pixel coordinates
function getCoordinatePoint(coord, canvas) {
    // Handle different coordinate formats
    let x, y;
    
    if (Array.isArray(coord)) {
        // Array format [x, y]
        [x, y] = coord;
    } else if (typeof coord === 'object') {
        // Object format {0: x, 1: y} or {x: x, y: y}
        x = coord['0'] !== undefined ? coord['0'] : coord.x;
        y = coord['1'] !== undefined ? coord['1'] : coord.y;
    } else {
        console.error("Invalid coordinate format:", coord);
        return [0, 0];
    }
    
    // Check if coordinates are normalized (between 0 and 1)
    if (0 <= x && x <= 1 && 0 <= y && y <= 1) {
        // Convert normalized coordinates to canvas pixels
        return [x * canvas.width, y * canvas.height];
    } else {
        // Already in pixels
        return [x, y];
    }
}

// Delete an ROI
function deleteROI(cameraId, roiId) {
    if (!confirm('Are you sure you want to delete this region?')) return;
    
    fetch(`/api/cameras/${cameraId}/roi/${roiId}`, {
        method: 'DELETE',
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Reload ROIs
            loadROIs(cameraId);
            console.log(`Deleted ROI ${roiId} for camera ${cameraId}`);
        } else {
            alert('Error deleting ROI: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting ROI:', error);
        alert('Error deleting ROI: ' + error.message);
    });
}
</script>
{% endblock %}