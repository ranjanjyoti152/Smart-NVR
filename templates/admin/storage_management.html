{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Database Storage Management</h5>
            </div>
            <div class="card-body">
                <p>Configure where MongoDB database files are stored and manage storage drives.</p>
                
                <!-- Current MongoDB Path -->
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-database me-3 fa-2x"></i>
                        <div>
                            <strong>Current MongoDB Data Path</strong>
                            <div id="currentPath">{{ mongodb_path }}</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6 class="mb-3">Storage Drives</h6>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Mount Point</th>
                                    <th>Device</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Free</th>
                                    <th>Usage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for drive in storage_info %}
                                <tr>
                                    <td>{{ drive.mountpoint }}</td>
                                    <td>{{ drive.device }}</td>
                                    <td>{{ drive.fstype }}</td>
                                    <td>{{ drive.total_formatted }}</td>
                                    <td>{{ drive.free_formatted }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            {% set bar_class = 'bg-success' %}
                                            {% if drive.percent > 90 %}
                                                {% set bar_class = 'bg-danger' %}
                                            {% elif drive.percent > 75 %}
                                                {% set bar_class = 'bg-warning' %}
                                            {% endif %}
                                            <div class="progress-bar {{ bar_class }}" role="progressbar" 
                                                 style="width: {{ drive.percent }}%;" 
                                                 aria-valuenow="{{ drive.percent }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">{{ drive.percent|round|int }}%</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-primary view-drive-btn"
                                                    data-path="{{ drive.mountpoint }}" aria-label="View drive details for {{ drive.mountpoint }}">
                                                <i class="fas fa-eye" aria-hidden="true"></i>
                                            </button>
                                            <button type="button" class="btn btn-info select-drive-btn"
                                                    data-path="{{ drive.mountpoint }}/mongodb" aria-label="Select drive {{ drive.mountpoint }} for MongoDB">
                                                <i class="fas fa-check" aria-hidden="true"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Drive Management Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Drive Management</h6>
                    </div>
                    <div class="card-body">
                        <form id="driveManagementForm">
                            <div class="row mb-3">
                                <div class="col-md-9">
                                    <label for="selectedDrive" class="form-label">Selected Drive Path</label>
                                    <input type="text" class="form-control" id="selectedDrive" placeholder="/path/to/drive">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="button" id="refreshDrivesBtn" class="btn btn-secondary w-100">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="format_type" class="form-label">Format Type</label>
                                    <select class="form-select" id="format_type">
                                        <option value="ext4">ext4 (Linux Standard)</option>
                                        <option value="xfs">XFS (High Performance)</option>
                                        <option value="btrfs">Btrfs (Better Resilience)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="mount_options" class="form-label">Mount Options</label>
                                    <input type="text" class="form-control" id="mount_options" value="defaults,noatime">
                                </div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="allow_formatting">
                                <label class="form-check-label" for="allow_formatting">
                                    Allow Drive Formatting
                                </label>
                                <div class="form-text text-danger">⚠️ Formatting will permanently erase ALL data on the drive!</div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button type="button" id="formatDriveBtn" class="btn btn-danger" disabled>
                                    <i class="fas fa-eraser"></i> Format Drive
                                </button>
                                <button type="button" id="mountDriveBtn" class="btn btn-primary">
                                    <i class="fas fa-plug"></i> Mount Drive
                                </button>
                                <button type="button" id="unmountDriveBtn" class="btn btn-secondary">
                                    <i class="fas fa-eject"></i> Unmount Drive
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Database Configuration Form -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Database Configuration</h6>
                    </div>
                    <div class="card-body">
                        <form id="dbConfigForm" action="{{ url_for('main.save_settings') }}" method="post">
                            <div class="mb-3">
                                <label for="db_storage_path" class="form-label">MongoDB Data Path</label>
                                <input type="text" class="form-control" id="db_storage_path" name="db_storage_path" 
                                       value="{{ settings.recording.db_storage_path|default('/var/lib/mongodb') }}">
                                <div class="form-text">Path where MongoDB database files are stored</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="db_storage_size" class="form-label">Maximum Database Size (GB)</label>
                                <input type="number" class="form-control" id="db_storage_size" name="db_storage_size" 
                                       value="{{ settings.recording.db_storage_size|default(20) }}" min="1" max="2000">
                                <div class="form-text">Maximum storage allocated for database files</div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="auto_mount" name="auto_mount"
                                       {% if settings.recording.auto_mount %}checked{% endif %}>
                                <label class="form-check-label" for="auto_mount">
                                    Auto-mount drive at startup
                                </label>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Changes to database storage location require restarting MongoDB service after saving.
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Configuration
                            </button>
                            <button type="button" id="restartMongoBtn" class="btn btn-warning ms-2">
                                <i class="fas fa-redo"></i> Restart MongoDB Service
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Drive Details Panel -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Drive Details</h5>
            </div>
            <div class="card-body" id="driveDetails">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-hdd fa-3x mb-3"></i>
                    <p>Select a drive to view details</p>
                </div>
            </div>
        </div>
        
        <!-- Help Panel -->
        <div class="card">
            <div class="card-header">
                <h5>Help & Information</h5>
            </div>
            <div class="card-body">
                <h6>Storage Management</h6>
                <p>This page allows you to manage where your database files are stored. For systems with limited root partition space, you can move the database to another drive.</p>
                
                <h6>Filesystem Types</h6>
                <ul>
                    <li><strong>ext4</strong> - Standard Linux filesystem, good balance of features</li>
                    <li><strong>XFS</strong> - Better performance for large databases</li>
                    <li><strong>Btrfs</strong> - Advanced features like snapshots and checksums</li>
                </ul>
                
                <h6>Mount Options</h6>
                <p>Common options:</p>
                <ul>
                    <li><code>defaults</code> - Standard mount options</li>
                    <li><code>noatime</code> - Don't update access times (better performance)</li>
                    <li><code>discard</code> - Enable TRIM for SSDs</li>
                </ul>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    For best database performance on SSDs, use "defaults,noatime,discard"
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drive Details Modal -->
<div class="modal fade" id="driveDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Drive Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="driveDetailsModalContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading drive details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Action Modal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmActionTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmActionMessage">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmActionBtn" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalTitle">Operation in Progress</h5>
                <button type="button" id="closeProgressModal" class="btn-close" aria-label="Close" style="display: none;"></button>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p id="progressModalMessage">Please wait while the operation completes...</p>
                <div id="progressModalError" class="alert alert-danger mt-3" style="display: none;">
                    <p>An error occurred or the operation is taking longer than expected.</p>
                    <button type="button" class="btn btn-sm btn-danger mt-2" onclick="forceCloseProgressModal()">
                        Force Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const selectedDriveInput = document.getElementById('selectedDrive');
    const dbStoragePath = document.getElementById('db_storage_path');
    const allowFormattingCheckbox = document.getElementById('allow_formatting');
    const formatDriveBtn = document.getElementById('formatDriveBtn');
    const mountDriveBtn = document.getElementById('mountDriveBtn');
    const unmountDriveBtn = document.getElementById('unmountDriveBtn');
    const refreshDrivesBtn = document.getElementById('refreshDrivesBtn'); // Fixed typo in ID reference
    const restartMongoBtn = document.getElementById('restartMongoBtn');
    const driveDetailsPanel = document.getElementById('driveDetails');
    
    // Modals
    const driveDetailsModal = new bootstrap.Modal(document.getElementById('driveDetailsModal'));
    const confirmActionModal = new bootstrap.Modal(document.getElementById('confirmActionModal'));
    const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
    
    // Get the CSRF token from meta tag (this line is added)
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    // Enable/disable format button based on checkbox
    allowFormattingCheckbox.addEventListener('change', function() {
        formatDriveBtn.disabled = !this.checked;
    });
    
    // Set up event handlers for all view drive buttons
    document.querySelectorAll('.view-drive-btn').forEach(button => {
        button.addEventListener('click', function() {
            const path = this.getAttribute('data-path');
            showDriveDetails(path);
        });
    });
    
    // Set up event handlers for all select drive buttons
    document.querySelectorAll('.select-drive-btn').forEach(button => {
        button.addEventListener('click', function() {
            const path = this.getAttribute('data-path');
            selectedDriveInput.value = path;
            dbStoragePath.value = path;
        });
    });
    
    // Format Drive Button
    formatDriveBtn.addEventListener('click', function() {
        const drivePath = selectedDriveInput.value;
        const formatType = document.getElementById('format_type').value;
        
        if (!drivePath) {
            showAlert('warning', 'Please select a drive first.');
            return;
        }
        
        // Extract the base mount point (removing any subdirectories)
        const mountPoint = drivePath.split('/').slice(0, 3).join('/');
        
        document.getElementById('confirmActionTitle').textContent = 'Confirm Drive Format';
        document.getElementById('confirmActionMessage').innerHTML = `
            <div class="alert alert-danger">
                <h6 class="text-danger"><i class="fas fa-exclamation-triangle"></i> WARNING!</h6>
                <p>You are about to FORMAT the drive at <strong>${mountPoint}</strong>.</p>
                <p>This will <strong>PERMANENTLY DELETE ALL DATA</strong> on this drive.</p>
                <p>The drive will be formatted as <strong>${formatType}</strong>.</p>
                <p>Are you absolutely sure you want to continue?</p>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="formatConfirmCheck">
                    <label class="form-check-label" for="formatConfirmCheck">
                        I understand this will permanently erase all data on the drive
                    </label>
                </div>
            </div>
        `;
        
        // Setup confirm button action
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Format Drive';
        confirmBtn.className = 'btn btn-danger';
        
        // Enable confirm button only when checkbox is checked
        document.getElementById('formatConfirmCheck').addEventListener('change', function() {
            confirmBtn.disabled = !this.checked;
        });
        
        confirmBtn.onclick = function() {
            confirmActionModal.hide();
            formatDrive(mountPoint, formatType);
        };
        
        confirmActionModal.show();
    });
    
    // Mount Drive Button
    mountDriveBtn.addEventListener('click', function() {
        const drivePath = selectedDriveInput.value;
        const mountOptions = document.getElementById('mount_options').value;
        
        if (!drivePath) {
            showAlert('warning', 'Please select a drive first.');
            return;
        }
        
        // Extract the base mount point
        const mountPoint = drivePath.split('/').slice(0, 3).join('/');
        
        mountDrive(mountPoint, mountOptions);
    });
    
    // Unmount Drive Button
    unmountDriveBtn.addEventListener('click', function() {
        const drivePath = selectedDriveInput.value;
        
        if (!drivePath) {
            showAlert('warning', 'Please select a drive first.');
            return;
        }
        
        // Extract the base mount point
        const mountPoint = drivePath.split('/').slice(0, 3).join('/');
        
        document.getElementById('confirmActionTitle').textContent = 'Confirm Unmount';
        document.getElementById('confirmActionMessage').innerHTML = `
            <p>Are you sure you want to unmount the drive at <strong>${mountPoint}</strong>?</p>
            <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> This will make the drive unavailable until it is mounted again.</p>
        `;
        
        // Setup confirm button action
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Unmount';
        confirmBtn.className = 'btn btn-warning';
        
        confirmBtn.onclick = function() {
            confirmActionModal.hide();
            unmountDrive(mountPoint);
        };
        
        confirmActionModal.show();
    });
    
    // Restart MongoDB Button
    restartMongoBtn.addEventListener('click', function() {
        document.getElementById('confirmActionTitle').textContent = 'Restart MongoDB Service';
        document.getElementById('confirmActionMessage').innerHTML = `
            <p>Are you sure you want to restart the MongoDB service?</p>
            <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> This will temporarily disconnect all database connections.</p>
        `;
        
        // Setup confirm button action
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Restart Service';
        confirmBtn.className = 'btn btn-warning';
        
        confirmBtn.onclick = function() {
            confirmActionModal.hide();
            restartMongoDB();
        };
        
        confirmActionModal.show();
    });
    
    // Function to show drive details
    function showDriveDetails(path) {
        document.getElementById('driveDetailsModalContent').innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading drive details for ${path}...</p>
            </div>
        `;
        
        driveDetailsModal.show();
        
        fetch(`/api/system/disk_info?path=${encodeURIComponent(path)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderDriveDetails(data);
                } else {
                    document.getElementById('driveDetailsModalContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i> Error: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('driveDetailsModalContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> Error fetching drive details: ${error}
                    </div>
                `;
                console.error('Error:', error);
            });
    }
    
    // Function to render drive details
    function renderDriveDetails(data) {
        const deviceInfo = data.device_info || {};
        let content = `
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">Basic Information</h6>
                    <table class="table table-sm">
                        <tr>
                            <th>Path:</th>
                            <td>${data.path}</td>
                        </tr>
                        <tr>
                            <th>Device:</th>
                            <td>${data.device || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Filesystem:</th>
                            <td>${data.filesystem_type || 'Unknown'}</td>
                        </tr>
                        <tr>
                            <th>Total Space:</th>
                            <td>${data.total_formatted}</td>
                        </tr>
                        <tr>
                            <th>Used Space:</th>
                            <td>${data.used_formatted} (${data.used_percent}%)</td>
                        </tr>
                        <tr>
                            <th>Free Space:</th>
                            <td>${data.free_formatted}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        
        if (Object.keys(deviceInfo).length > 0) {
            content += `
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Device Information</h6>
                        <table class="table table-sm">
                            ${deviceInfo.name ? `<tr><th>Name:</th><td>${deviceInfo.name}</td></tr>` : ''}
                            ${deviceInfo.size ? `<tr><th>Size:</th><td>${deviceInfo.size}</td></tr>` : ''}
                            ${deviceInfo.fstype ? `<tr><th>Filesystem:</th><td>${deviceInfo.fstype}</td></tr>` : ''}
                            ${deviceInfo.label ? `<tr><th>Label:</th><td>${deviceInfo.label}</td></tr>` : ''}
                            ${deviceInfo.model ? `<tr><th>Model:</th><td>${deviceInfo.model}</td></tr>` : ''}
                            ${deviceInfo.serial ? `<tr><th>Serial:</th><td>${deviceInfo.serial}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
            `;
        }
        
        if (data.mongodb_using_path) {
            content += `
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-database"></i> MongoDB is currently using this path.
                </div>
            `;
        }
        
        document.getElementById('driveDetailsModalContent').innerHTML = content;
        
        // Also update the side panel
        const usedPercent = data.used_percent || 0;
        let barClass = 'bg-success';
        if (usedPercent > 90) barClass = 'bg-danger';
        else if (usedPercent > 75) barClass = 'bg-warning';
        
        driveDetailsPanel.innerHTML = `
            <h6>${data.path}</h6>
            <div class="d-flex justify-content-between">
                <span>Total: ${data.total_formatted}</span>
                <span>Free: ${data.free_formatted}</span>
            </div>
            <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar ${barClass}" role="progressbar" 
                     style="width: ${usedPercent}%;" aria-valuenow="${usedPercent}" 
                     aria-valuemin="0" aria-valuemax="100">${usedPercent}%</div>
            </div>
            <div class="mb-3">
                <strong>Filesystem:</strong> ${data.filesystem_type || 'Unknown'}
            </div>
            <div class="mb-3">
                <strong>Device:</strong> ${data.device || 'Unknown'}
            </div>
            <button class="btn btn-sm btn-primary select-for-db-btn" data-path="${data.path}/mongodb">
                <i class="fas fa-database"></i> Use for Database
            </button>
        `;
        
        // Add event listener to the "Use for Database" button
        document.querySelector('.select-for-db-btn').addEventListener('click', function() {
            const path = this.getAttribute('data-path');
            dbStoragePath.value = path;
            selectedDriveInput.value = path;
            showAlert('info', `Selected ${path} for database storage`);
        });
    }
    
    // Format drive function
    function formatDrive(mountPoint, formatType) {
        const mountOptions = document.getElementById('mount_options').value;
        
        showProgressModal('Formatting Drive', 'This may take several minutes. Please do not close or refresh the page.');
        
        fetch('/api/system/format_drive', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                mount_point: mountPoint,
                format_type: formatType,
                mount_options: mountOptions
            })
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                showAlert('success', 'Drive formatted successfully.');
            } else {
                showAlert('danger', `Error formatting drive: ${data.error}`);
            }
        })
        .catch(error => {
            hideProgressModal();
            showAlert('danger', 'Error during drive formatting operation.');
            console.error('Error:', error);
        });
    }
    
    // Mount drive function
    function mountDrive(mountPoint, mountOptions) {
        showProgressModal('Mounting Drive', 'Attempting to mount the drive...');
        
        fetch('/api/system/mount_drive', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                mount_point: mountPoint,
                mount_options: mountOptions
            })
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                showAlert('success', 'Drive mounted successfully.');
            } else {
                showAlert('danger', `Error mounting drive: ${data.error}`);
            }
        })
        .catch(error => {
            hideProgressModal();
            showAlert('danger', 'Error during drive mounting operation.');
            console.error('Error:', error);
        });
    }
    
    // Unmount drive function
    function unmountDrive(mountPoint) {
        showProgressModal('Unmounting Drive', 'Attempting to unmount the drive...');
        
        fetch('/api/system/unmount_drive', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                mount_point: mountPoint
            })
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                showAlert('success', 'Drive unmounted successfully.');
            } else {
                showAlert('danger', `Error unmounting drive: ${data.error}`);
            }
        })
        .catch(error => {
            hideProgressModal();
            showAlert('danger', 'Error during drive unmounting operation.');
            console.error('Error:', error);
        });
    }
    
    // Restart MongoDB function
    function restartMongoDB() {
        showProgressModal('Restarting MongoDB', 'Please wait while the MongoDB service restarts...');
        
        // Call the API endpoint to restart MongoDB
        fetch('/api/system/restart_mongodb', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            hideProgressModal();
            if (data.success) {
                showAlert('success', 'MongoDB service restarted successfully.');
            } else {
                showAlert('danger', `Error restarting MongoDB: ${data.error}`);
            }
        })
        .catch(error => {
            hideProgressModal();
            showAlert('danger', 'Error during MongoDB restart operation.');
            console.error('Error:', error);
        });
    }
    
    // Show progress modal with safety timeout
    function showProgressModal(title, message) {
        document.getElementById('progressModalTitle').textContent = title;
        document.getElementById('progressModalMessage').textContent = message;
        document.getElementById('progressModalError').style.display = 'none';
        document.getElementById('closeProgressModal').style.display = 'none';
        
        // Set a safety timeout - if operation takes too long, show error message and close button
        setTimeout(() => {
            const closeBtn = document.getElementById('closeProgressModal');
            const errorDiv = document.getElementById('progressModalError');
            if (closeBtn && errorDiv) {
                closeBtn.style.display = 'block';
                errorDiv.style.display = 'block';
                closeBtn.addEventListener('click', forceCloseProgressModal);
            }
        }, 60000); // 60 seconds timeout
        
        progressModal.show();
    }
    
    // Force close the progress modal
    function forceCloseProgressModal() {
        progressModal.hide();
        showAlert('warning', 'Operation was interrupted or timed out.');
    }
    
    // Show alert function
    function showAlert(type, message) {
        const alertsContainer = document.getElementById('alertsContainer');
        if (!alertsContainer) {
            // Create alerts container if it doesn't exist
            document.body.insertAdjacentHTML('beforeend', '<div id="alertsContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 2000;"></div>');
        }
        
        // Create alert ID
        const alertId = 'alert-' + Date.now();
        
        // Add alert to container
        document.getElementById('alertsContainer').insertAdjacentHTML('beforeend', `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" style="min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                const bsAlert = new bootstrap.Alert(alertElement);
                bsAlert.close();
            }
        }, 5000);
    }
    
    // Refresh button functionality
    refreshDrivesBtn.addEventListener('click', function() {
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        
        // Reload the page to get fresh drive information
        window.location.reload();
    });
</script>
{% endblock %}